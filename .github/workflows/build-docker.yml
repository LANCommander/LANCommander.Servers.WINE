name: Build & Push WINE Server (Docker Hub)

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: "Docker Hub image name (e.g., lancommander/wine)"
        required: true
        default: "lancommander/wine"
      version:
        description: "Version tag for the image"
        required: true
        default: "latest"
      push_latest:
        description: "Also push the :latest tag (arch-suffixed)"
        required: true
        type: boolean
        default: true

  push:
    tags:
      - "v*"

permissions:
  contents: read

concurrency:
  group: dockerhub-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - targetarch: "386"
            platform: "linux/386"
            arch_tag: "386"
          - targetarch: "amd64"
            platform: "linux/amd64"
            arch_tag: "amd64"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Derive settings from either tag push or workflow_dispatch inputs
      - name: Resolve build variables
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            # Tag push, e.g. refs/tags/v3339
            TAG_NAME="${GITHUB_REF_NAME}"
            VERSION="${TAG_NAME#v}"

            # Default image name for tag builds:
            IMAGE_NAME="${{ vars.DOCKERHUB_IMAGE_NAME }}"
            if [[ -z "${IMAGE_NAME}" ]]; then
              echo "DOCKERHUB_IMAGE_NAME variable is not set. Create it (e.g., 'lancommander/wine') or use workflow_dispatch."
              exit 1
            fi

            PUSH_LATEST="true"
          else
            IMAGE_NAME="${{ inputs.image_name }}"
            VERSION="${{ inputs.version }}"
            PUSH_LATEST="${{ inputs.push_latest }}"
          fi

          echo "image_name=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "push_latest=${PUSH_LATEST}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Arch-specific tags/labels
      - name: Docker metadata (arch)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.vars.outputs.image_name }}
          tags: |
            type=raw,value=${{ steps.vars.outputs.version }}-${{ matrix.arch_tag }}
            type=raw,value=latest-${{ matrix.arch_tag }},enable=${{ steps.vars.outputs.push_latest == 'true' }}
          labels: |
            org.opencontainers.image.title=Generic WINE Runtime Image
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.description=WINE base image (arch-specific build)

      - name: Build and push (${{ matrix.platform }}, TARGETARCH=${{ matrix.targetarch }})
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            TARGETARCH=${{ matrix.targetarch }}

      - name: Summary
        run: |
          echo "Pushed image: ${{ steps.vars.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Arch: ${{ matrix.arch_tag }} (platform ${{ matrix.platform }})" >> $GITHUB_STEP_SUMMARY
          echo "Tags: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ steps.vars.outputs.version }}" >> $GITHUB_STEP_SUMMARY